<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Student Face Recognition</title>
    <style>
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 1000;
            visibility: hidden;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Student Face Recognition</h1>

        <!-- OBS Giriş ve Profil Resmi Alma -->
        <div class="card p-4 mb-3">
            <h3>Load OBS Profile Image</h3>
            <input type="text" id="usernameInput" class="form-control mb-2" placeholder="Enter OBS Username">
            <input type="password" id="passwordInput" class="form-control mb-2" placeholder="Enter OBS Password">
            <button id="loadObsImageBtn" class="btn btn-primary">Load Profile Image</button>
            <div class="mt-3" id="obsImageContainer" style="text-align: center;">
                <img id="obsProfileImage" src="" alt="OBS Profile Image" style="max-width: 200px; display: none;">
            </div>
        </div>

        <!-- Section for live webcam -->
        <div class="card p-4 mb-3">
            <h3>Live Webcam Feed</h3>
            <video id="webcam" class="d-block mx-auto border" autoplay muted width="320" height="240"></video>
            <button id="captureBtn" class="btn btn-primary mt-3 d-block mx-auto">Compare Faces</button>
        </div>

        <!-- Result Section -->
        <div class="card p-4">
            <h3>Result</h3>
            <p id="result" class="text-center text-secondary"></p>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen">We are trying to detect now...</div>

    <script>
        async function loadModels() {
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
        try {
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
            ]);
            console.log('Face-api models loaded successfully.');
        } catch (error) {
            console.error('Error loading face-api models:', error);
            alert('Failed to load face-api models. Please check your internet connection.');
        }
    }

        async function setupWebcam() {
            const webcam = document.getElementById('webcam');
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Your browser does not support webcam access.');
                }

                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcam.srcObject = stream;
                webcam.play();
                console.log('Webcam is active.');
            } catch (err) {
                console.error('Error accessing webcam:', err);
                alert('Webcam access denied or unavailable. Please check your browser settings and permissions.');
            }
        }



        async function loadObsImage() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!username || !password) {
                alert('Please enter both username and password.');
                return;
            }

            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.visibility = 'visible';

            try {
                const response = await fetch('http://127.0.0.1:5000/get-profile-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch profile image. Check your credentials.');
                }

                const data = await response.json();
                const base64Image = data.profile_image;

                // Base64'ten resim oluştur
                const obsProfileImage = await loadImageFromBase64(base64Image);
                document.getElementById('obsProfileImage').src = base64Image;
                document.getElementById('obsProfileImage').style.display = 'block';

                console.log('Profile image loaded successfully.');
            } catch (error) {
                alert(error.message);
            } finally {
                loadingScreen.style.visibility = 'hidden';
            }
        }

        // Base64'ten HTMLImageElement'e dönüştürme fonksiyonu
        async function loadImageFromBase64(base64) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = base64;
                img.onload = () => resolve(img);
                img.onerror = (err) => reject(err);
            });
        }

        async function compareFaces() {
            const webcam = document.getElementById('webcam');
            const obsProfileImage = document.getElementById('obsProfileImage');
            const resultElement = document.getElementById('result');

            if (!obsProfileImage.src || !obsProfileImage.src.startsWith('data:image/')) {
                alert('Please load the OBS profile image first.');
                return;
            }

            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.visibility = 'visible';

            try {
                if (!webcam.videoWidth || !webcam.videoHeight) {
                    throw new Error('Webcam feed is not ready. Please try again.');
                }

                // Kameradan alınan görüntüyü canvas ile işleme
                const webcamCanvas = document.createElement('canvas');
                webcamCanvas.width = webcam.videoWidth;
                webcamCanvas.height = webcam.videoHeight;
                const webcamCtx = webcamCanvas.getContext('2d');
                webcamCtx.drawImage(webcam, 0, 0, webcamCanvas.width, webcamCanvas.height);

                // Görüntüyü Base64'e çevir
                const webcamImage = webcamCanvas.toDataURL('image/jpeg');

                // Backend'e gönderilecek JSON verisi
                const payload = {
                    obsImage: obsProfileImage.src,
                    webcamImage,
                };

                if (!payload.obsImage.startsWith('data:image/') || !payload.webcamImage.startsWith('data:image/')) {
                    throw new Error('Invalid image format. Please try again.');
                }

                // Backend API'sine gönder
                const response = await fetch('http://127.0.0.1:5000/compare-faces', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to compare faces.');
                }

                const result = await response.json();

                if (!result || typeof result.match === 'undefined') {
                    throw new Error('Unexpected response format from server.');
                }

                // Sonuçları göster
                resultElement.innerText = result.match
                    ? '✅ Match: Same person detected!'
                    : '❌ No match: Different person.';
                resultElement.className = result.match ? 'text-success' : 'text-danger';
            } catch (error) {
                resultElement.innerText = error.message;
                resultElement.className = 'text-danger';
            } finally {
                loadingScreen.style.visibility = 'hidden';
            }
        }

        document.getElementById('loadObsImageBtn').addEventListener('click', loadObsImage);
        document.getElementById('captureBtn').addEventListener('click', compareFaces);

        document.addEventListener('DOMContentLoaded', async () => {
            await loadModels();
            setupWebcam();
        });

    </script>
</body>
</html>
